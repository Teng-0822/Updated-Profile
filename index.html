<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Profile Manager</title>
  <style>
    button, input, label {
      touch-action: manipulation;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #101010;
      min-height: 100vh;
      color: #f5f5f5;
      touch-action: manipulation;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 90px;
    }
    @supports (padding: max(0px)) {
      body {
        padding-top: max(12px, env(safe-area-inset-top));
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
    .nav-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .nav-buttons button {
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: #1a1a1a;
      color: #f5f5f5;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid #2a2a2a;
    }
    .nav-buttons button:hover {
      transform: translateY(-2px);
      background: #2a2a2a;
    }
    .nav-buttons button:active {
      transform: translateY(0);
      background: #0a0a0a;
    }
    #profileBox {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #2a2a2a;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
    }
    #profileBox.active {
      border: 1px solid #00ba7c;
      box-shadow: 0 0 0 1px rgba(0, 186, 124, 0.1);
    }
    #profileBox.suspended {
      border: 1px solid #ff4444;
      box-shadow: 0 0 0 1px rgba(255, 68, 68, 0.1);
    }
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .action-buttons button {
      padding: 14px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: #1a1a1a;
      color: #f5f5f5;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: 1px solid #2a2a2a;
    }
    .action-buttons button:hover {
      transform: translateY(-2px);
      background: #2a2a2a;
    }
    .action-buttons button:active {
      background: #0a0a0a;
      transform: translateY(0);
    }
    /* New 3-box IP section */
    .ip-section-new {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .ip-box {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      border: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 110px;
    }
    .ip-box button {
      width: 100%;
      padding: 12px;
      background: #f5f5f5;
      color: #101010;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
    }
    .ip-box button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .ip-box .label {
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }
    .ip-box .value {
      font-size: 15px;
      font-weight: 700;
      color: #f5f5f5;
      word-break: break-all;
    }
    #statusBox {
      background: #2a2a2a !important;
      transition: background 0.4s ease;
    }
    #statusBox.green {
      background: #00ba7c !important;
    }
    #statusBox.red {
      background: #ff4444 !important;
    }
    /* Floating Buttons */
    .floating-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #1a1a1a;
      backdrop-filter: blur(10px);
      box-shadow: 0 -1px 0 #2a2a2a;
      z-index: 1000;
      border-top: 1px solid #2a2a2a;
    }
    @supports (padding: max(0px)) {
      .floating-buttons {
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }
    }
    .floating-btn {
      flex: 1;
      height: 50px;
      border-radius: 12px;
      border: none;
      background: #f5f5f5;
      color: #101010;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .floating-btn:active {
      transform: scale(0.95);
      background: #fff;
    }
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: #1a1a1a;
      padding: 28px;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #2a2a2a;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: #2a2a2a;
      color: #999;
      font-size: 20px;
      cursor: pointer;
    }
    .modal-close:hover {
      background: #3a3a3a;
      color: #f5f5f5;
      transform: rotate(90deg);
    }
    .url-input-group {
      margin-bottom: 20px;
    }
    .url-input-group label {
      display: block;
      font-weight: 600;
      color: #999;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .url-input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      font-size: 14px;
      background: #101010;
      color: #f5f5f5;
    }
    .url-input-group input:focus {
      outline: none;
      border-color: #f5f5f5;
      background: #0a0a0a;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }
    .btn-primary {
      background: #f5f5f5;
      color: #101010;
    }
    .btn-secondary {
      background: #2a2a2a;
      color: #f5f5f5;
    }
    /* Toast */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background: #f5f5f5;
      color: #101010;
      font-weight: 600;
      text-align: center;
      border-radius: 12px;
      padding: 16px 24px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }
    #toast.show {
      visibility: visible;
      animation: slideUp 0.3s, slideDown 0.3s 2.5s;
    }
    @keyframes slideUp {
      from { bottom: 0; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }
    @keyframes slideDown {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 0; opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-buttons">
      <button onclick="prevProfile()">‚¨ÖÔ∏è Previous</button>
      <button onclick="runNextContainer(); nextProfile()">Next ‚û°Ô∏è</button>
      <button onclick="GotoFirst(); goToFirstProfile()">üîÅ First</button>
      <button onclick="preloadSheets()">üîÑ Refresh</button>
    </div>

    <!-- Profile Box - Username Only -->
    <div id="profileBox">
      <span id="username">-</span>
    </div>

    <div class="action-buttons">
      <button onclick="showModal('profileModal')">üìÑ Accounts</button>
      <button onclick="linkPost()">üîó Link Post</button>
      <button onclick="openThreadsMediaPicker()">üñä Pick Image</button>
      <button onclick="pickTodayPost()">üìÖ Pick Post</button>
      <button onclick="pickRandom('Reply'); openThreads()">üí¨ Pick Reply</button>
      <button onclick="pickRandom('Comments'); openThreads()">üí≠ Pick Comment</button>
    </div>

    <!-- New 3-box IP Section -->
    <div class="ip-section-new">
      <div class="ip-box">
        <div class="label">1. Store & Rotate</div>
        <button id="storeRotateBtn" onclick="storeAndRotate()">üîÑ Rotate Now</button>
        <div class="value" id="storedIP">‚Äî</div>
      </div>
      <div class="ip-box">
        <div class="label">2. Compare</div>
        <button onclick="compareIPs()">üîç Check Change</button>
        <div class="value" id="currentIPDisplay">fetching...</div>
      </div>
      <div class="ip-box" id="statusBox">
        <div class="label">3. Result (15s)</div>
        <div class="value" id="statusText">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Floating Buttons - Both kept -->
  <div class="floating-buttons">
    <button class="floating-btn" onclick="showModal('sheetUrlModal')" title="Change Sheet URL">
      üìä Sheet URL
    </button>
    <button class="floating-btn" onclick="showModal('rotateUrlModal')" title="Change Rotate URL">
      üîÑ Rotate URL
    </button>
  </div>

  <!-- Sheet URL Modal -->
  <div id="sheetUrlModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('sheetUrlModal')">‚úï</button>
      <h3>Change Sheet URL</h3>
      <div class="url-input-group">
        <label>Google Sheets URL</label>
        <input type="text" id="sheetUrlInput" placeholder="Enter your sheet URL">
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="hideModal('sheetUrlModal')">Cancel</button>
        <button class="btn-primary" onclick="saveSheetUrl()">Save</button>
      </div>
    </div>
  </div>

  <!-- Rotate URL Modal - KEPT -->
  <div id="rotateUrlModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('rotateUrlModal')">‚úï</button>
      <h3>Change Rotate URL</h3>
      <div class="url-input-group">
        <label>IP Rotation URL</label>
        <input type="text" id="rotateUrlInput" placeholder="Enter your rotate URL">
      </div>
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="hideModal('rotateUrlModal')">Cancel</button>
        <button class="btn-primary" onclick="saveRotateUrl()">Save</button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('profileModal')">‚úï</button>
      <h3>üìÑ Accounts Sheet</h3>
      <table id="profileTable"></table>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // URLs
    const DEFAULT_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxl9YgraQ_0ZHX90hsHf3L9U8QHDOVRtfegquHj-yLbbmeVdyvur_dToRDrsm9ThF7sMw/exec';
    let sheetUrl = localStorage.getItem('sheetUrl') || DEFAULT_SHEET_URL;
    let rotateUrl = localStorage.getItem('rotateUrl') || "https://i.fxdx.in/actionlinks/do/changeip/YTbojipTQnuowNvn2MkNoA";

    let profiles = [], currentProfile = 0;
    let sheetCache = {}, pickedPostIndexes = {};
    let userIP = null;
    let storedIP = null;
    let statusTimeout = null;

    function runNextContainer() {
      window.location.href = "shortcuts://run-shortcut?name=Next%20container";
    }
    function GotoFirst() {
      window.location.href = "shortcuts://run-shortcut?name=first";
    }
    function linkPost() {
      window.open("https://www.threads.net/@piperallyglow/post/DSgboU8DEia");
    }

    function saveSheetUrl() {
      const input = document.getElementById('sheetUrlInput');
      const newUrl = input.value.trim();
      if (newUrl) {
        sheetUrl = newUrl;
        localStorage.setItem('sheetUrl', newUrl);
        sheetCache = {};
        showToast("Sheet URL saved!");
        hideModal('sheetUrlModal');
        preloadSheets();
      } else {
        showToast("Please enter a valid URL");
      }
    }

    function saveRotateUrl() {
      const input = document.getElementById('rotateUrlInput');
      const newUrl = input.value.trim();
      if (newUrl) {
        rotateUrl = newUrl;
        localStorage.setItem('rotateUrl', newUrl);
        showToast("Rotate URL saved!");
        hideModal('rotateUrlModal');
      } else {
        showToast("Please enter a valid URL");
      }
    }

    async function fetchSheet(sheetName) {
      if (sheetCache[sheetName]) return sheetCache[sheetName];
      const res = await fetch(`${sheetUrl}?sheet=${sheetName}`);
      if (!res.ok) throw new Error("Failed to fetch " + sheetName);
      const data = await res.json();
      sheetCache[sheetName] = data;
      return data;
    }

    async function preloadSheets() {
      try {
        setButtonsDisabled(true);
        showToast("Refreshing data...");
        sheetCache = {};
        const savedIndex = parseInt(localStorage.getItem('lastProfileIndex')) || 0;
        profiles = await fetchSheet('Accounts');
        sheetCache['Posts'] = await fetchSheet('Posts');
        sheetCache['Reply'] = await fetchSheet('Reply');
        sheetCache['Comments'] = await fetchSheet('Comments');
        sheetCache['Caption'] = await fetchSheet('Caption');
        showToast("Sheets refreshed!");
        displayProfile(savedIndex);
      } catch (e) {
        showToast("Refresh failed");
        console.error(e);
      } finally {
        setButtonsDisabled(false);
      }
    }

    function displayProfile(index) {
      if (profiles.length === 0) return;
      currentProfile = (index + profiles.length) % profiles.length;
      localStorage.setItem('lastProfileIndex', currentProfile);
      const profile = profiles[currentProfile];
      document.getElementById('username').textContent = profile.username || '-';

      const box = document.getElementById('profileBox');
      box.className = '';
      if (profile.status) {
        const status = (profile.status || "").toLowerCase();
        if (status === "active") box.classList.add('active');
        else if (status === "suspended") box.classList.add('suspended');
      }
    }

    function nextProfile() { displayProfile(currentProfile + 1); }
    function prevProfile() { displayProfile(currentProfile - 1); }
    function goToFirstProfile() { displayProfile(0); }

    function showModal(id) {
      if (id === 'profileModal') loadAccounts();
      if (id === 'sheetUrlModal') document.getElementById('sheetUrlInput').value = sheetUrl;
      if (id === 'rotateUrlModal') document.getElementById('rotateUrlInput').value = rotateUrl;
      document.getElementById(id).style.display = 'flex';
    }
    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    async function loadAccounts() {
      try {
        const accounts = await fetchSheet('Accounts');
        const table = document.getElementById("profileTable");
        table.innerHTML = '<tr><th>Username</th><th>Container ID</th></tr>' +
          accounts.map(p => `<tr><td>${p.username || '-'}</td><td>${p.container || '-'}</td></tr>`).join('');
      } catch (e) {
        showToast("Failed to load accounts");
      }
    }

    function pickRandom(sheetName) {
      showToast(`Copying from ${sheetName}...`);
      fetchSheet(sheetName).then(data => {
        const choice = data[Math.floor(Math.random() * data.length)];
        let value = Object.values(choice)[0];
        const loc = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || "";
        value = value.replace(/\(loc\)/gi, loc);
        navigator.clipboard.writeText(value);
        showToast(`${sheetName} copied!`);
      }).catch(() => showToast(`Failed to load ${sheetName}`));
    }

    async function openThreadsMediaPicker() {
      const sheetName = 'Caption';
      try {
        showToast(`Picking from ${sheetName}...`);
        const data = await fetchSheet(sheetName);
        if (!data || data.length === 0) return showToast(`No captions found`);
        let used = JSON.parse(localStorage.getItem('usedCaptionIndexes') || '[]');
        if (used.length >= data.length) { used = []; localStorage.setItem('usedCaptionIndexes', '[]'); }
        const unused = data.map((row, i) => ({i, row})).filter(x => !used.includes(x.i));
        const selected = unused[Math.floor(Math.random() * unused.length)];
        used.push(selected.i);
        localStorage.setItem('usedCaptionIndexes', JSON.stringify(used));
        let value = Object.values(selected.row)[0];
        const loc = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || "";
        value = value.replace(/\(loc\)/gi, loc);
        await navigator.clipboard.writeText(value);
        showToast("Caption copied!");
        window.open("https://www.threads.net/intent/post");
      } catch (e) {
        showToast(`Failed to load ${sheetName}`);
      }
    }

    async function pickTodayPost() {
      try {
        showToast("Picking today's post...");
        const posts = await fetchSheet('Posts');
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const today = days[new Date().getDay()];
        const todayPosts = posts.map((row, i) => ({i, text: row[today]})).filter(p => p.text?.trim());
        let picked = JSON.parse(localStorage.getItem(`pickedPost_${today}`) || '[]');
        const unused = todayPosts.filter(p => !picked.includes(p.i));
        if (unused.length === 0) {
          picked = [];
          localStorage.setItem(`pickedPost_${today}`, '[]');
          showToast("All posts used today, restarting");
        }
        const selected = unused[Math.floor(Math.random() * unused.length)];
        picked.push(selected.i);
        localStorage.setItem(`pickedPost_${today}`, JSON.stringify(picked));
        const loc = profiles[currentProfile]?.location || profiles[currentProfile]?.Location || "";
        const finalText = selected.text.replace(/\(loc\)/gi, loc);
        const encoded = encodeURIComponent(finalText);
        window.open(`https://www.threads.net/intent/post?text=${encoded}`);
        showToast("Opening Threads‚Ä¶");
      } catch (e) {
        showToast("Error picking post");
      }
    }

    function openThreads() {
      window.open("https://threads.net/");
    }

    function setButtonsDisabled(disabled) {
      document.querySelectorAll('button:not(.floating-btn)').forEach(btn => btn.disabled = disabled);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "show";
      setTimeout(() => toast.className = "", 2500);
    }

    // IP Functions
    async function fetchIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch (e) {
        return null;
      }
    }

    async function updateCurrentIPDisplay() {
      const newIP = await fetchIP();
      userIP = newIP;
      document.getElementById("currentIPDisplay").textContent = newIP || "error";
      return newIP;
    }

    async function storeAndRotate() {
      const btn = document.getElementById("storeRotateBtn");
      btn.disabled = true;
      showToast("Fetching IP & sending rotate...");

      const current = await updateCurrentIPDisplay();
      if (!current) {
        showToast("Failed to fetch IP");
        btn.disabled = false;
        return;
      }

      storedIP = current;
      document.getElementById("storedIP").textContent = storedIP;

      // Trigger rotation using saved/custom URL
      new Image().src = rotateUrl + (rotateUrl.includes('?') ? '&' : '?') + 't=' + Date.now();

      showToast("Rotate command sent. Wait then compare.");
      btn.disabled = false;
    }

    async function compareIPs() {
      if (!storedIP) {
        showToast("First click 'Rotate Now' to store IP");
        return;
      }

      showToast("Checking current IP...");
      const current = await updateCurrentIPDisplay();

      const statusBox = document.getElementById("statusBox");
      const statusText = document.getElementById("statusText");

      if (statusTimeout) clearTimeout(statusTimeout);

      if (current && current !== storedIP) {
        statusBox.className = "ip-box green";
        statusText.textContent = "CHANGED ‚úÖ";
        showToast("IP changed successfully!");
      } else {
        statusBox.className = "ip-box red";
        statusText.textContent = "SAME ‚ùå";
        showToast("IP did not change");
      }

      statusTimeout = setTimeout(() => {
        statusBox.className = "ip-box";
        statusText.textContent = "‚Äî";
      }, 15000);
    }

    window.onload = () => {
      document.getElementById('sheetUrlInput').value = sheetUrl;
      document.getElementById('rotateUrlInput').value = rotateUrl;
      preloadSheets();
      updateCurrentIPDisplay();
      setInterval(updateCurrentIPDisplay, 30000);
    };
  </script>
</body>
</html>
